from fastapi.testclient import TestClient
from app.main import app

client = TestClient(app)

def test_api_security_malware_upload():
    """
    SECURITY TEST: Uploading a text file renamed as .jpg
    Should FAIL with 400 (Security Violation)
    """
    # Create a fake malicious file (e.g. a script text)
    fake_malware = b"print('This is a virus')"
    
    response = client.post(
        "/api/v1/detect/",
        files={"file": ("virus.jpg", fake_malware, "image/jpeg")}
    )
    
    # Assertions
    assert response.status_code == 400
    assert "Security Violation" in response.json()["detail"]
    print("\n✅ Security Test Passed: Malware file rejected!")

def test_api_valid_image():
    """
    NORMAL TEST: Uploading a real JPG header
    Should PASS (or fail later at YOLO if model missing, but pass security)
    """
    # Valid JPEG Header (FF D8 FF)
    valid_header = b"\xff\xd8\xff\xe0\x00\x10JFIF"
    
    response = client.post(
        "/api/v1/detect/",
        files={"file": ("valid_test.jpg", valid_header, "image/jpeg")}
    )
    
    # We expect 200 OK or 500 (if model fails), but NOT 400 Security Error
    assert response.status_code != 400
    print("\n✅ Normal Test Passed: Valid Header accepted!")
